<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Join Room - FoodMate</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* Reset margin/padding ของ body เพื่อให้ header ชิดขอบบน */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #ffebe0;
      color: #333;
    }

    /* สไตล์สำหรับ header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      padding: 10px 20px;
    }

    .header h2 {
      margin: 0;
      font-size: 20px;
      color: #ff5722;
      font-weight: bold;
    }

    .header .leave-room {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .header .leave-room:hover {
      color: #343a40;
    }

    /* Container สำหรับจัดหน้าเว็บ (sidebar + main content) */
    .container {
      display: flex;
      width: 100%;
      /* ถ้าต้องการให้ห่างจาก header เล็กน้อย */
      margin-top: 0;
      /* หรือปรับเป็น margin-top: 10px; */
    }

    /* Sidebar */
    .sidebar {
      width: 20%;
      background-color: #fff3e0;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .sidebar h3 {
      margin-top: 0;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar ul li {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border: 2px solid white;
      padding: 5px;
      border-radius: 8px;
    }

    .sidebar ul li img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    /* Main Content */
    .main-content {
      width: 80%;
      padding: 20px;
    }

    /* Card สำหรับแสดงข้อมูลอาหาร */
    .food-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .food-card img {
      width: 40%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .food-info {
      margin-top: 20px;
    }

    .food-info h3 {
      font-size: 24px;
      color: #e74c3c;
      margin: 0;
    }

    .food-info p {
      font-size: 16px;
      color: #777;
      margin: 5px 0 15px 0;
    }

    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    .buttons button {
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
    }

    .buttons .dislike {
      background-color: #ff6b6b;
      color: #fff;
    }

    .buttons .neutral {
      background-color: #f1c40f;
      color: #fff;
    }

    .buttons .like {
      background-color: #2ecc71;
      color: #fff;
    }

    .buttons button:hover {
      opacity: 0.8;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .action-buttons button {
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      transition: 0.3s;
    }

    .action-buttons .view-results {
      background-color: #e67e22;
      color: #fff;
    }

    .action-buttons .vote-restaurant {
      background-color: #e74c3c;
      color: #fff;
    }

    .action-buttons button:hover {
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="header">
    <h2 id="roomTitle">Food Group #</h2>
    <button class="leave-room" id="leaveRoomBtn">
      <i class="fas fa-door-open"></i> Leave Room
    </button>
  </div>

  <div class="container">
    <div class="sidebar">
      <h3 id="memberCount">Members (0)</h3>
      <ul id="memberList">
        <!-- รายชื่อสมาชิกจะถูกแทรกที่นี่ -->
      </ul>

    </div>
    <div class="main-content">
      <div class="food-card">
        <div class="food-header">
          <h2>Current Selection <span class="counter"></span></h2>
        </div>
        <img src="https://cdn.discordapp.com/attachments/1340746744165564477/1340762871658713160/image.png"
          alt="Food" />
        <div class="food-info">
          <h3 id="foodName">ข้าวกะเพรา</h3>
          <p id="foodDescription">ข้าวกะเพราหมูสับ</p>
          <div class="buttons">
            <button class="dislike">
              <i class="fas fa-times"></i> Dislike
            </button>
            <button class="neutral">
              <i class="fas fa-meh"></i> Neutral
            </button>
            <button class="like">
              <i class="fas fa-check"></i> Like
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="view-results">
          <i class="fas fa-chart-bar"></i> View AI Results
        </button>
        <button class="vote-restaurant">
          <i class="fas fa-utensils"></i> Vote for Restaurant
        </button>

      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // ดึง query parameters จาก URL
      const params = new URLSearchParams(window.location.search);
      const roomID = params.get("roomID");
      const host = params.get("host"); // หากต้องการใช้งาน host ต่อไป

      if (!roomID) {
        console.error("roomID parameter is missing in the URL");
        return;
      }

      console.log("Room ID:", roomID);

      // ดึงรายชื่อสมาชิกและ room_name จาก API โดยส่ง roomID ไปด้วย
      fetch(`${API_BASE_URL}/roomMembers.php?roomID=` + encodeURIComponent(roomID))
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            // แสดง room_name ที่ดึงมาจาก DB
            document.getElementById("roomTitle").textContent = "Food Group #" + data.room_name;

            const members = data.members;
            const memberList = document.getElementById("memberList");
            memberList.innerHTML = ""; // ล้างรายการเก่าออก

            members.forEach((member) => {
              // สร้าง li สำหรับสมาชิกแต่ละคน
              const li = document.createElement("li");
              const profileImage = member.profileImage ? member.profileImage : "../image/cat.png";
              const hostLabel = member.isHost == 1 ? " (Host)" : "";
              li.innerHTML = `<img src="${profileImage}" alt="${member.Username}">
                                  <span>${member.Username}${hostLabel}</span>`;
              memberList.appendChild(li);
            });

            document.getElementById("memberCount").textContent = "Members (" + members.length + ")";
          } else {
            console.error("Error fetching room members:", data.message);
          }
        })
        .catch((error) => console.error("Error:", error));

      // --- ตัวอย่าง Event Listeners สำหรับปุ่มต่าง ๆ ---
      const voteFood = (voteType) => {
        const foodName = document.getElementById("foodName").textContent;
        const foodDescription = document.getElementById("foodDescription").textContent;

        fetch(`${API_BASE_URL}/vote.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            roomID: roomID,
            foodName: foodName,
            vote: voteType,
          }),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);
          })
          .catch((error) => console.error("Error sending vote for food:", error));
      };

      document.querySelector(".dislike").addEventListener("click", () => voteFood("dislike"));
      document.querySelector(".neutral").addEventListener("click", () => voteFood("neutral"));
      document.querySelector(".like").addEventListener("click", () => voteFood("like"));

      document.querySelector(".view-results").addEventListener("click", () => {
        window.location.href = "aiResults.html?roomID=" + encodeURIComponent(roomID);
      });

      document.querySelector(".vote-restaurant").addEventListener("click", () => {
        window.location.href = "voteRestaurant.html?roomID=" + encodeURIComponent(roomID);
      });

      // กำหนด Event Listener ให้กับปุ่ม Leave Room
      document.getElementById("leaveRoomBtn").addEventListener("click", function () {
        leaveRoom(roomID);
      });
      document.getElementById("leaveRoomBtn").addEventListener("click", function () {
        // ดึง roomID จาก query string หรือแหล่งข้อมูลอื่น ๆ
        const params = new URLSearchParams(window.location.search);
        const roomID = params.get("roomID");

        // ดึง userID จาก localStorage (หรือจาก query string)
        const userID = localStorage.getItem("userID");

        if (!roomID || !userID) {
          alert("Missing roomID or userID.");
          return;
        }

        // เรียก API leaveRoom
        fetch(`${API_BASE_URL}/leaveRoom.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            roomID: roomID,
            joinerId: userID
          })
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            // หาก host leave room และห้องถูกลบแล้ว ให้ redirect ไปที่หน้า dashboard
            if (data.status === 'success') {
              window.location.href = 'home.html';
            }
          })
          .catch(error => console.error("Error:", error));
      });

      function leaveRoom(roomID) {
        // สมมติว่าค่า userID ถูกเก็บใน localStorage หรือดึงจาก URL แล้วเก็บในตัวแปร userID
        const userID = localStorage.getItem("userID");

        fetch(`${API_BASE_URL}/leaveRoom.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            roomID: roomID,
            joinerId: userID,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            // หาก host ออกจากห้องแล้วและห้องถูกลบ อาจ redirect ไปยังหน้าอื่น เช่น หน้า dashboard
            if (data.status === "success") {
              window.location.href = "home.html";
            }
          })
          .catch((error) => console.error("Error:", error));
      }
    });
  </script>

  <!-- API_BASE_URL ควรถูกประกาศไว้ในไฟล์ api.js หรือในสคริปต์นี้ -->
  <script src="../api/api.js"></script>
</body>

</html>