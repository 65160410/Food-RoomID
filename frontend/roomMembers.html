<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Food Group #2814</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ไอคอน Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #ffeedc; /* สีพื้นหลัง */
      color: #333;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 10px 20px;
      border-bottom: 1px solid #eee;
    }
    .header h2 {
      margin: 0;
      font-size: 20px;
      color: #ff5722;
      font-weight: bold;
    }
    .leave-room {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .leave-room:hover {
      color: #343a40;
    }

    /* Container (Sidebar + Main) */
    .container {
      display: flex;
      width: 100%;
      margin-top: 0;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background-color: #fff;
      padding: 20px;
      border-right: 1px solid #eee;
    }
    .sidebar h3 {
      margin-top: 0;
      font-size: 16px;
      margin-bottom: 15px;
      color: #333;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar ul li {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      cursor: default;
    }
    .sidebar ul li img {
      border-radius: 50%;
      width: 35px;
      height: 35px;
      margin-right: 10px;
    }

    /* Main content */
    .main-content {
      flex: 1;
      padding: 20px;
    }

    /* Search bar */
    .search-bar {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      position: relative;
    }
    .search-bar input {
      width: 250px;
      padding: 8px 35px 8px 15px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 14px;
      outline: none;
    }
    .search-bar .fa-magnifying-glass {
      position: absolute;
      right: 10px;
      color: #aaa;
      font-size: 14px;
    }

    /* Cards layout: 2 columns, 2 rows */
    .cards-wrapper {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-gap: 20px;
    }

    /* Card */
    .food-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      padding: 15px;
      text-align: center;
    }
    .food-card img {
      width: 80%;
      max-width: 250px;
      height: auto;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .food-card h3 {
      font-size: 16px;
      color: #333;
      margin: 0;
      margin-bottom: 5px;
    }
    .food-card p {
      font-size: 14px;
      color: #666;
      margin: 0;
      margin-bottom: 15px;
    }

    /* ปุ่ม Like/Dislike (ขอบสี พื้นขาว) */
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .buttons button {
      border-radius: 5px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.3s;
      background-color: #fff;
      border: 2px solid transparent;
    }
    .like {
      border-color: #28a745;
      color: #28a745;
    }
    .like:hover {
      background-color: #28a745;
      color: #fff;
    }
    .dislike {
      border-color: #dc3545;
      color: #dc3545;
    }
    .dislike:hover {
      background-color: #dc3545;
      color: #fff;
    }

    /* Action buttons ด้านล่าง */
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .action-buttons button {
      border: none;
      padding: 12px 30px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
      color: #fff;
      background-color: #ff6b35;
    }
    .action-buttons button:hover {
      opacity: 0.9;
    }

    /* Responsive: ถ้าจอแคบ ให้ Sidebar ขึ้นข้างบน Main */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        display: flex;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid #eee;
      }
      .main-content {
        width: 100%;
      }
      .cards-wrapper {
        grid-template-columns: 1fr; /* เหลือคอลัมน์เดียวบนจอเล็ก */
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h2 id="roomTitle">Food Group #2814</h2>
    <button class="leave-room" id="leaveRoomBtn">
      <i class="fas fa-door-open"></i> Leave Room
    </button>
  </div>

  <!-- Container -->
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h3 id="memberCount">Members (0)</h3>
      <ul id="memberList">
        
      </ul>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <!-- Search bar -->
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ค้นหาอาหารที่คุณชื่นชอบ">
        <i class="fas fa-magnifying-glass"></i>
      </div>
      

      <!-- Cards Wrapper (4 ใบ) -->
      <div class="cards-wrapper">
        <!-- Card 1 -->
              <!-- Cards Wrapper -->
      <div class="cards-wrapper" id="cardsWrapper">
        <!-- รายการเมนูอาหารจะถูกแสดงที่นี่จากการค้นหา -->
      </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="view-results"><i class="fas fa-chart-bar"></i> View AI Results</button>
        <button class="vote-restaurant"><i class="fas fa-utensils"></i> Vote for Restaurant</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const searchInput = document.getElementById("searchInput");
      const cardsWrapper = document.getElementById("cardsWrapper");
      
      // เมื่อผู้ใช้พิมพ์ในช่องค้นหา
      searchInput.addEventListener("input", function() {
        const query = searchInput.value.trim().toLowerCase();
        searchMenuItems(query);
      });
      
      // ฟังก์ชันเรียก API ค้นหาเมนูอาหาร
      async function searchMenuItems(query) {
        try {
          // เรียก API searchMenuItems.php โดยส่ง q เป็น query string
          const response = await fetch(`${API_BASE_URL}/searchMenuItems.php?q=${encodeURIComponent(query)}`);
          const result = await response.json();
          console.log("Search result:", result);
          if (result.status === "success") {
            displayMenuCards(result.data);
          } else {
            cardsWrapper.innerHTML = "<p>ไม่พบข้อมูล</p>";
          }
        } catch (error) {
          console.error("Error searching menu items:", error);
          cardsWrapper.innerHTML = "<p>เกิดข้อผิดพลาดในการค้นหา</p>";
        }
      }
      
      // ฟังก์ชันแสดงผลลัพธ์เป็นการ์ด
      function displayMenuCards(items) {
        if (!items || items.length === 0) {
          cardsWrapper.innerHTML = "<p>ไม่พบเมนูอาหารที่ค้นหา</p>";
          return;
        }
        cardsWrapper.innerHTML = "";
        items.forEach(item => {
          const card = document.createElement("div");
          card.classList.add("food-card");
          const imgUrl = item.imageUrl ? item.imageUrl : "../image/placeholder.png";
          card.innerHTML = `
            <img src="${imgUrl}" alt="${item.menuName}">
            <div class="food-info">
              <h3>${item.menuName}</h3>
              <p>${item.description ? item.description : ""}</p>
            </div>
            <div class="buttons">
              <button class="like">Like</button>
              <button class="dislike">Dislike</button>
            </div>
          `;
          cardsWrapper.appendChild(card);
        });
      }
      
      // เรียกค้นหาเมนูอาหารทั้งหมดเมื่อโหลดหน้า (query เป็นค่าว่าง)
      searchMenuItems("");
    });


    document.addEventListener("DOMContentLoaded", function () {
      // ดึง query parameters จาก URL
      const params = new URLSearchParams(window.location.search);
      const roomID = params.get("roomID");
      const host = params.get("host"); // หากต้องการใช้งาน host ต่อไป

      if (!roomID) {
        console.error("roomID parameter is missing in the URL");
        return;
      }

      console.log("Room ID:", roomID);

      // ดึงรายชื่อสมาชิกและ room_name จาก API โดยส่ง roomID ไปด้วย
      fetch(`${API_BASE_URL}/roomMembers.php?roomID=` + encodeURIComponent(roomID))
        .then((response) => response.json())
        .then((data) => {
          if (data.status === "success") {
            // แสดง room_name ที่ดึงมาจาก DB
            document.getElementById("roomTitle").textContent = "Food Group #" + data.room_name;

            const members = data.members;
            const memberList = document.getElementById("memberList");
            memberList.innerHTML = ""; // ล้างรายการเก่าออก

            members.forEach((member) => {
              // สร้าง li สำหรับสมาชิกแต่ละคน
              const li = document.createElement("li");
              const profileImage = member.profileImage ? member.profileImage : "../image/cat.png";
              const hostLabel = member.isHost == 1 ? " (Host)" : "";
              li.innerHTML = `<img src="${profileImage}" alt="${member.Username}">
                                  <span>${member.Username}${hostLabel}</span>`;
              memberList.appendChild(li);
            });

            document.getElementById("memberCount").textContent = "Members (" + members.length + ")";
          } else {
            console.error("Error fetching room members:", data.message);
          }
        })
        .catch((error) => console.error("Error:", error));

      // --- ตัวอย่าง Event Listeners สำหรับปุ่มต่าง ๆ ---
      const voteFood = (voteType) => {
        const foodName = document.getElementById("foodName").textContent;
        const foodDescription = document.getElementById("foodDescription").textContent;

        fetch(`${API_BASE_URL}/vote.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            roomID: roomID,
            foodName: foodName,
            vote: voteType,
          }),
        })
          .then((response) => response.json())
          .then((result) => {
            alert(result.message);
          })
          .catch((error) => console.error("Error sending vote for food:", error));
      };

      document.querySelector(".dislike").addEventListener("click", () => voteFood("dislike"));
      document.querySelector(".neutral").addEventListener("click", () => voteFood("neutral"));
      document.querySelector(".like").addEventListener("click", () => voteFood("like"));

      document.querySelector(".view-results").addEventListener("click", () => {
        window.location.href = "aiResults.html?roomID=" + encodeURIComponent(roomID);
      });

      document.querySelector(".vote-restaurant").addEventListener("click", () => {
        window.location.href = "voteRestaurant.html?roomID=" + encodeURIComponent(roomID);
      });

      // กำหนด Event Listener ให้กับปุ่ม Leave Room
      document.getElementById("leaveRoomBtn").addEventListener("click", function () {
        leaveRoom(roomID);
      });
      document.getElementById("leaveRoomBtn").addEventListener("click", function () {
        // ดึง roomID จาก query string หรือแหล่งข้อมูลอื่น ๆ
        const params = new URLSearchParams(window.location.search);
        const roomID = params.get("roomID");

        // ดึง userID จาก localStorage (หรือจาก query string)
        const userID = localStorage.getItem("userID");

        if (!roomID || !userID) {
  
          return;
        }

        // เรียก API leaveRoom
        fetch(`${API_BASE_URL}/leaveRoom.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            roomID: roomID,
            joinerId: userID
          })
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            // หาก host leave room และห้องถูกลบแล้ว ให้ redirect ไปที่หน้า dashboard
            if (data.status === 'success') {
              window.location.href = 'home.html';
            }
          })
          .catch(error => console.error("Error:", error));
      });

      function leaveRoom(roomID) {
        // อ่านค่า userID และ guestUserID จาก localStorage
        const userID = localStorage.getItem("userID");
        const guestID = localStorage.getItem("guestUserID");
        // เลือกใช้ userID ถ้ามี แต่ถ้าไม่มีให้ใช้ guestUserID
        const joinerId = userID ? userID : guestID;

        if (!roomID || !joinerId) {
          alert("Missing parameters: roomID and joinerId are required.");
          return;
        }

        fetch(`${API_BASE_URL}/leaveRoom.php`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            roomID: roomID,
            joinerId: parseInt(joinerId)
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            alert(data.message);
            // หาก host ออกจากห้องแล้วและห้องถูกลบ ให้ redirect ไปยังหน้าอื่น (เช่นหน้า dashboard)
            if (data.status === "success") {
              window.location.href = "home.html";
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      function updateMemberList(roomID) {
        fetch(`${API_BASE_URL}/roomMembers.php?roomID=` + encodeURIComponent(roomID))
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              document.getElementById("roomTitle").textContent = "Food Group #" + data.room_name;
              const members = data.members;
              const memberList = document.getElementById("memberList");
              memberList.innerHTML = ""; // ล้างรายการเก่าออก

              members.forEach((member) => {
                const li = document.createElement("li");
                const profileImage = member.profileImage ? member.profileImage : "../image/cat.png";
                const hostLabel = member.isHost == 1 ? " (Host)" : "";
                li.innerHTML = `<img src="${profileImage}" alt="${member.Username}">
                              <span>${member.Username}${hostLabel}</span>`;
                memberList.appendChild(li);
              });
              document.getElementById("memberCount").textContent = "Members (" + members.length + ")";
            } else {
              console.error("Error fetching room members:", data.message);
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // เรียกใช้ฟังก์ชัน updateMemberList ทุก ๆ 5 วินาที
      setInterval(() => {
        const params = new URLSearchParams(window.location.search);
        const roomID = params.get("roomID");
        if (roomID) {
          updateMemberList(roomID);
        }
      }, 5000); // 5000 มิลลิวินาที = 5 วินาที

    });
  </script>

  <!-- API_BASE_URL ควรถูกประกาศไว้ในไฟล์ api.js หรือในสคริปต์นี้ -->
  <script src="../api/api.js"></script>
</body>

</html>